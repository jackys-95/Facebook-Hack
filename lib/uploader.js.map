{"version":3,"sources":["../scripts/uploader.js"],"names":[],"mappings":"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","file":"uploader.js","sourcesContent":["/**\n * Copyright 2015 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n'use strict';\n\nwindow.friendlyPix = window.friendlyPix || {};\n\n/**\n * Handles uploads of new pics.\n */\nfriendlyPix.Uploader = class {\n\n  /**\n   * @return {number}\n   */\n  static get FULL_IMAGE_SPECS() {\n    return {\n      maxDimension: 1280,\n      quality: 0.9\n    };\n  }\n\n  /**\n   * @return {number}\n   */\n  static get THUMB_IMAGE_SPECS() {\n    return {\n      maxDimension: 640,\n      quality: 0.7\n    };\n  }\n\n  /**\n   * Inititializes the pics uploader/post creator.\n   * @constructor\n   */\n  constructor() {\n    // Firebase SDK\n    this.database = firebase.app().database();\n    this.auth = firebase.app().auth();\n    this.storage = firebase.app().storage();\n\n    this.addPolyfills();\n\n    $(document).ready(() => {\n      // DOM Elements\n      this.addButton = $('#add');\n      this.addButtonFloating = $('#add-floating');\n      this.imageInput = $('#fp-mediacapture');\n      this.overlay = $('.fp-overlay', '#page-add');\n      this.newPictureContainer = $('#newPictureContainer');\n      this.uploadButton = $('.fp-upload');\n      this.imageCaptionInput = $('#imageCaptionInput');\n      this.uploadPicForm = $('#uploadPicForm');\n      this.toast = $('.mdl-js-snackbar');\n\n      // Event bindings\n      this.addButton.click(() => this.initiatePictureCapture());\n      this.addButtonFloating.click(() => this.initiatePictureCapture());\n      this.imageInput.change(e => this.readPicture(e));\n      this.uploadPicForm.submit(e => this.uploadPic(e));\n      this.imageCaptionInput.keyup(() => this.uploadButton.prop('disabled', !this.imageCaptionInput.val()));\n    });\n  }\n\n  // Adds polyfills requireed for the Uploader.\n  addPolyfills() {\n    // Polyfill for canvas.toBlob().\n    if (!HTMLCanvasElement.prototype.toBlob) {\n      Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {\n        value: function(callback, type, quality) {\n          var binStr = atob(this.toDataURL(type, quality).split(',')[1]);\n          var len = binStr.length;\n          var arr = new Uint8Array(len);\n\n          for (var i = 0; i < len; i++) {\n            arr[i] = binStr.charCodeAt(i);\n          }\n\n          callback(new Blob([arr], {type: type || 'image/png'}));\n        }\n      });\n    }\n  }\n\n  /**\n   * Start taking a picture.\n   */\n  initiatePictureCapture() {\n    this.imageInput.trigger('click');\n  }\n\n  /**\n   * Displays the given pic in the New Pic Upload dialog.\n   */\n  displayPicture(url) {\n    this.newPictureContainer.attr('src', url);\n    page('/add');\n    this.imageCaptionInput.focus();\n    this.uploadButton.prop('disabled', true);\n  }\n\n  /**\n   * Enables or disables the UI. Typically while the image is uploading.\n   */\n  disableUploadUi(disabled) {\n    this.uploadButton.prop('disabled', disabled);\n    this.addButton.prop('disabled', disabled);\n    this.addButtonFloating.prop('disabled', disabled);\n    this.imageCaptionInput.prop('disabled', disabled);\n    this.overlay.toggle(disabled);\n  }\n\n  /**\n   * Reads the picture the has been selected by the file picker.\n   */\n  readPicture(event) {\n    this.clear();\n\n    var file = event.target.files[0]; // FileList object\n    this.currentFile = file;\n\n    // Clear the selection in the file picker input.\n    this.imageInput.wrap('<form>').closest('form').get(0).reset();\n    this.imageInput.unwrap();\n\n    // Only process image files.\n    if (file.type.match('image.*')) {\n      var reader = new FileReader();\n      reader.onload = e => this.displayPicture(e.target.result);\n      // Read in the image file as a data URL.\n      reader.readAsDataURL(file);\n      this.disableUploadUi(false);\n    }\n  }\n\n  /**\n   * Returns a Canvas containing the given image scaled down to the given max dimension.\n   * @private\n   * @static\n   */\n  static _getScaledCanvas(image, maxDimension) {\n    const thumbCanvas = document.createElement('canvas');\n    if (image.width > maxDimension ||\n      image.height > maxDimension) {\n      if (image.width > image.height) {\n        thumbCanvas.width = maxDimension;\n        thumbCanvas.height = maxDimension * image.height / image.width;\n      } else {\n        thumbCanvas.width = maxDimension * image.width / image.height;\n        thumbCanvas.height = maxDimension;\n      }\n    } else {\n      thumbCanvas.width = image.width;\n      thumbCanvas.height = image.height;\n    }\n    thumbCanvas.getContext('2d').drawImage(image, 0, 0, image.width, image.height,\n      0, 0, thumbCanvas.width, thumbCanvas.height);\n    return thumbCanvas;\n  }\n\n  /**\n   * Generates the full size image and image thumb using canvas and returns them in a promise.\n   */\n  generateImages() {\n    const fullDeferred = new $.Deferred();\n    const thumbDeferred = new $.Deferred();\n\n    const resolveFullBlob = blob => fullDeferred.resolve(blob);\n    const resolveThumbBlob = blob => thumbDeferred.resolve(blob);\n\n    const displayPicture = url => {\n      const image = new Image();\n      image.src = url;\n\n      // Generate thumb.\n      const maxThumbDimension = friendlyPix.Uploader.THUMB_IMAGE_SPECS.maxDimension;\n      const thumbCanvas = friendlyPix.Uploader._getScaledCanvas(image, maxThumbDimension);\n      thumbCanvas.toBlob(resolveThumbBlob, 'image/jpeg', friendlyPix.Uploader.THUMB_IMAGE_SPECS.quality);\n\n      // Generate full sized image.\n      const maxFullDimension = friendlyPix.Uploader.FULL_IMAGE_SPECS.maxDimension;\n      const fullCanvas = friendlyPix.Uploader._getScaledCanvas(image, maxFullDimension);\n      fullCanvas.toBlob(resolveFullBlob, 'image/jpeg', friendlyPix.Uploader.FULL_IMAGE_SPECS.quality);\n    };\n\n    const reader = new FileReader();\n    reader.onload = e => displayPicture(e.target.result);\n    reader.readAsDataURL(this.currentFile);\n\n    return Promise.all([fullDeferred.promise(), thumbDeferred.promise()]).then(results => {\n      return {\n        full: results[0],\n        thumb: results[1]\n      };\n    });\n  }\n\n  /**\n   * Uploads the pic to Firebase Storage and add a new post into the Firebase Database.\n   */\n  uploadPic(e) {\n    e.preventDefault();\n    this.disableUploadUi(true);\n    var imageCaption = this.imageCaptionInput.val();\n\n    this.generateImages().then(pics => {\n      // Upload the File upload to Firebase Storage and create new post.\n      friendlyPix.firebase.uploadNewPic(pics.full, pics.thumb, this.currentFile.name, imageCaption)\n          .then(postId => {\n            page(`/user/${this.auth.currentUser.uid}`);\n            var data = {\n              message: 'New pic has been posted!',\n              actionHandler: () => page(`/post/${postId}`),\n              actionText: 'View',\n              timeout: 10000\n            };\n            this.toast[0].MaterialSnackbar.showSnackbar(data);\n            this.disableUploadUi(false);\n          }, () => {\n            var data = {\n              message: `There was an error while posting your pic. Sorry!`,\n              timeout: 5000\n            };\n            this.toast[0].MaterialSnackbar.showSnackbar(data);\n            this.disableUploadUi(false);\n          });\n        });\n  }\n\n  /**\n   * Clear the uploader.\n   */\n  clear() {\n    this.currentFile = null;\n\n    // Cancel all Firebase listeners.\n    friendlyPix.firebase.cancelAllSubscriptions();\n\n    // Clear previously displayed pic.\n    this.newPictureContainer.attr('src', '');\n\n    // Clear the text field.\n    friendlyPix.MaterialUtils.clearTextField(this.imageCaptionInput[0]);\n\n    // Make sure UI is not disabled.\n    this.disableUploadUi(false);\n  }\n};\n\nfriendlyPix.uploader = new friendlyPix.Uploader();\n"]}