{"version":3,"sources":["../scripts/feed.js"],"names":[],"mappings":"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","file":"feed.js","sourcesContent":["/**\n * Copyright 2015 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n'use strict';\n\nwindow.friendlyPix = window.friendlyPix || {};\n\n/**\n * Handles the Home and Feed UI.\n */\nfriendlyPix.Feed = class {\n\n  /**\n   * Initializes the Friendly Pix feeds.\n   * @constructor\n   */\n  constructor() {\n    // List of all posts on the page.\n    this.posts = [];\n    // Map of posts that can be displayed.\n    this.newPosts = {};\n\n    // Firebase SDK.\n    this.auth = firebase.app().auth();\n\n    $(document).ready(() => {\n      // Pointers to DOM elements.\n      this.pageFeed = $('#page-feed');\n      this.feedImageContainer = $('.fp-image-container', this.pageFeed);\n      this.noPostsMessage = $('.fp-no-posts', this.pageFeed);\n      this.nextPageButton = $('.fp-next-page-button button');\n      this.newPostsButton = $('.fp-new-posts-button button');\n\n      // Event bindings.\n      this.newPostsButton.click(() => this.showNewPosts());\n    });\n  }\n\n  /**\n   * Appends the given list of `posts`.\n   */\n  addPosts(posts) {\n    // Displays the list of posts\n    const postIds = Object.keys(posts);\n    for (let i = postIds.length - 1; i >= 0; i--) {\n      this.noPostsMessage.hide();\n      const postData = posts[postIds[i]];\n      const post = friendlyPix.post.clone();\n      this.posts.push(post);\n      const postElement = post.fillPostData(postIds[i], postData.thumb_url || postData.url,\n          postData.text, postData.author, postData.timestamp, null, null, postData.full_url);\n      // If a post with similar ID is already in the feed we replace it instead of appending.\n      const existingPostElement = $(`.fp-post-${postIds[i]}`, this.feedImageContainer);\n      if (existingPostElement.length) {\n        existingPostElement.replaceWith(postElement);\n      } else {\n        this.feedImageContainer.append(postElement.addClass(`fp-post-${postIds[i]}`));\n      }\n    }\n  }\n\n  /**\n   * Shows the \"load next page\" button and binds it the `nextPage` callback. If `nextPage` is `null`\n   * then the button is hidden.\n   */\n  toggleNextPageButton(nextPage) {\n    this.nextPageButton.unbind('click');\n    if (nextPage) {\n      const loadMorePosts = () => {\n        this.nextPageButton.prop('disabled', true);\n        console.log('Loading next page of posts.');\n        nextPage().then(data => {\n          this.addPosts(data.entries);\n          this.toggleNextPageButton(data.nextPage);\n        });\n      };\n      this.nextPageButton.show();\n      // Enable infinite Scroll.\n      friendlyPix.MaterialUtils.onEndScroll(100).then(loadMorePosts);\n      this.nextPageButton.prop('disabled', false);\n      this.nextPageButton.click(loadMorePosts);\n    } else {\n      this.nextPageButton.hide();\n    }\n  }\n\n  /**\n   * Prepends the list of new posts stored in `this.newPosts`. This happens when the user clicks on\n   * the \"Show new posts\" button.\n   */\n  showNewPosts() {\n    const newPosts = this.newPosts;\n    this.newPosts = {};\n    this.newPostsButton.hide();\n    const postKeys = Object.keys(newPosts);\n\n    for (let i = 0; i < postKeys.length; i++) {\n      this.noPostsMessage.hide();\n      const post = newPosts[postKeys[i]];\n      const postElement = friendlyPix.post.clone();\n      this.posts.push(postElement);\n      this.feedImageContainer.prepend(postElement.fillPostData(postKeys[i], post.thumb_url ||\n          post.url, post.text, post.author, post.timestamp, null, null, post.full_url));\n    }\n  }\n\n  /**\n   * Displays the general posts feed.\n   */\n  showGeneralFeed() {\n    // Clear previously displayed posts if any.\n    this.clear();\n\n    // Load initial batch of posts.\n    friendlyPix.firebase.getPosts().then(data => {\n      // Listen for new posts.\n      const latestPostId = Object.keys(data.entries)[Object.keys(data.entries).length - 1];\n      friendlyPix.firebase.subscribeToGeneralFeed(\n          (postId, postValue) => this.addNewPost(postId, postValue), latestPostId);\n\n      // Adds fetched posts and next page button if necessary.\n      this.addPosts(data.entries);\n      this.toggleNextPageButton(data.nextPage);\n    });\n\n    // Listen for posts deletions.\n    friendlyPix.firebase.registerForPostsDeletion(postId => this.onPostDeleted(postId));\n  }\n\n  /**\n   * Shows the feed showing all followed users.\n   */\n  showHomeFeed() {\n    // Clear previously displayed posts if any.\n    this.clear();\n\n    if (this.auth.currentUser) {\n      // Make sure the home feed is updated with followed users's new posts.\n      friendlyPix.firebase.updateHomeFeeds().then(() => {\n        // Load initial batch of posts.\n        friendlyPix.firebase.getHomeFeedPosts().then(data => {\n          const postIds = Object.keys(data.entries);\n          if (postIds.length === 0) {\n            this.noPostsMessage.fadeIn();\n          }\n          // Listen for new posts.\n          const latestPostId = postIds[postIds.length - 1];\n          friendlyPix.firebase.subscribeToHomeFeed(\n              (postId, postValue) => {\n                this.addNewPost(postId, postValue);\n              }, latestPostId);\n\n          // Adds fetched posts and next page button if necessary.\n          this.addPosts(data.entries);\n          this.toggleNextPageButton(data.nextPage);\n        });\n\n        // Add new posts from followers live.\n        friendlyPix.firebase.startHomeFeedLiveUpdaters();\n\n        // Listen for posts deletions.\n        friendlyPix.firebase.registerForPostsDeletion(postId => this.onPostDeleted(postId));\n      });\n    }\n  }\n\n  /**\n   * Triggered when a post has been deleted.\n   */\n  onPostDeleted(postId) {\n    // Potentially remove post from in-memory new post list.\n    if (this.newPosts[postId]) {\n      delete this.newPosts[postId];\n      const nbNewPosts = Object.keys(this.newPosts).length;\n      this.newPostsButton.text(`Display ${nbNewPosts} new posts`);\n      if (nbNewPosts === 0) {\n        this.newPostsButton.hide();\n      }\n    }\n\n    // Potentially delete from the UI.\n    $(`.fp-post-${postId}`, this.pageFeed).remove();\n  }\n\n  /**\n   * Adds a new post to display in the queue.\n   */\n  addNewPost(postId, postValue) {\n    this.newPosts[postId] = postValue;\n    this.newPostsButton.text(`Display ${Object.keys(this.newPosts).length} new posts`);\n    this.newPostsButton.show();\n  }\n\n  /**\n   * Clears the UI.\n   */\n  clear() {\n    // Delete the existing posts if any.\n    $('.fp-post', this.feedImageContainer).remove();\n\n    // Hides the \"next page\" and \"new posts\" buttons.\n    this.nextPageButton.hide();\n    this.newPostsButton.hide();\n\n    // Remove any click listener on the next page button.\n    this.nextPageButton.unbind('click');\n\n    // Stops then infinite scrolling listeners.\n    friendlyPix.MaterialUtils.stopOnEndScrolls();\n\n    // Clears the list of upcoming posts to display.\n    this.newPosts = {};\n\n    // Displays the help message for empty feeds.\n    this.noPostsMessage.hide();\n\n    // Remove Firebase listeners.\n    friendlyPix.firebase.cancelAllSubscriptions();\n\n    // Stops all timers if any.\n    this.posts.forEach(post => post.clear());\n    this.posts = [];\n  }\n};\n\nfriendlyPix.feed = new friendlyPix.Feed();\n"]}